{
  "id": "program-flamenco-pro-v4-ki",
  "type": "executable",
  "title": "游눆 TABLAO: GU칈A DE RITMOS 游눆",
  "parentId": "folder-1766530794088863",
  "content": {
    "nodes": [
      {
        "id": "node-start-flamenco",
        "type": "start",
        "x": 50,
        "y": 50,
        "inputs": [],
        "outputs": [
          "out"
        ],
        "values": {},
        "uiFlags": {}
      },
      {
        "id": "node-flamenco-engine",
        "type": "flamenco-silenos-v4",
        "x": 350,
        "y": 80,
        "inputs": [
          "open"
        ],
        "outputs": [
          "interaction_end"
        ],
        "values": {
          "titulo": "Tablao: El Matiz del Silencio"
        },
        "uiFlags": {
          "titulo": false
        }
      }
    ],
    "connections": [
      {
        "fromNode": "node-start-flamenco",
        "fromPort": "out",
        "toNode": "node-flamenco-engine",
        "toPort": "open"
      }
    ],
    "panX": 0,
    "panY": 0,
    "scale": 1,
    "embeddedModules": [
      {
        "id": "flamenco-silenos-v4",
        "title": "Tablao Matiz (Z-H-R)",
        "color": "#7f1d1d",
        "inputs": [
          "open"
        ],
        "outputs": [
          "interaction_end"
        ],
        "fields": [
          {
            "name": "titulo",
            "type": "text",
            "value": "Resonancia y Matiz"
          }
        ],
        "code": "\nconst winId = 'flamenco-v4-window';\nconst existing = document.getElementById(winId);\nif (existing) { existing.remove(); return; }\n\n// --- MOTOR DE AUDIO (R-G-M) ---\nlet audioCtx = null;\n\nconst playPercussion = (type, volume = 0.5) => {\n    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();\n    const osc = audioCtx.createOscillator();\n    const gain = audioCtx.createGain();\n    gain.connect(audioCtx.destination);\n\n    if (type === 'CAJON_BASS') {\n        osc.frequency.setValueAtTime(150, audioCtx.currentTime);\n        osc.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + 0.1);\n        gain.gain.setValueAtTime(volume, audioCtx.currentTime);\n        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.2);\n        osc.connect(gain); osc.start(); osc.stop(audioCtx.currentTime + 0.2);\n    } else if (type === 'PALMA_SECA') {\n        const noise = audioCtx.createBufferSource();\n        const buffer = audioCtx.createBuffer(1, 44100 * 0.05, 44100);\n        const data = buffer.getChannelData(0);\n        for (let i = 0; i < data.length; i++) data[i] = Math.random() * 2 - 1;\n        noise.buffer = buffer;\n        gain.gain.setValueAtTime(volume, audioCtx.currentTime);\n        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.05);\n        noise.connect(gain); noise.start();\n    }\n};\n\n// --- CONFIGURACI칍N DE RITMOS (12 PALOS) ---\nconst regiones = {\n    'JEREZ': { palo: 'Buler칤as', compas: [1,0,0,1,0,1,0,1,0,1,0,1], accents: [3,6,8,10,12], color: '#f59e0b', info: 'Cima del entendimiento (Z).' },\n    'C츼DIZ': { palo: 'Alegr칤as', compas: [1,0,0,1,0,1,0,1,0,1,0,1], accents: [3,6,8,10,12], color: '#0ea5e9', info: 'Resonancia (R) del Atl치ntico.' },\n    'TRIANA': { palo: 'Sole치', compas: [1,0,0,1,0,1,0,1,0,1,0,1], accents: [3,6,8,10,12], color: '#4c1d95', info: 'Soporte de energ칤a (D).' },\n    'GRANADA': { palo: 'Siguiriya', compas: [1,0,1,0,1,0,0,1,0,0,1,0], accents: [1,3,5,8,11], color: '#111827', info: 'Direcci칩n y flujo (K).' },\n    'M츼LAGA': { palo: 'Tangos', compas: [1,0,1,0,1,0,1,0], accents: [1,3,5,7], color: '#059669', info: 'Variabilidad y juegos (J).' },\n    'HUELVA': { palo: 'Fandangos', compas: [1,0,1], accents: [1], color: '#d97706', info: 'Uni칩n y Acci칩n (U-A).' },\n    'MURCIA': { palo: 'Tarantos', compas: [1,0,1,0,1,0,1,0], accents: [1,3,5,7], color: '#4b5563', info: 'Granularidad minera (G).' },\n    'PETENERA': { palo: 'Petenera', compas: [1,0,0,1,0,0,1,0,1,0,1,0], accents: [1,4,7,9,11], color: '#701a75', info: 'L칤mite y frontera (L).' },\n    'BAMBERA': { palo: 'Bambera', compas: [1,0,0,1,0,1,0,1,0,1,0,1], accents: [3,6,8,10,12], color: '#be123c', info: 'Equilibrio en el aire (E).' },\n    'HABANA': { palo: 'Guajira', compas: [1,0,0,1,0,1,0,1,0,1,0,1], accents: [3,6,8,10,12], color: '#10b981', info: 'Confluencia de caminos (Y).' },\n    'SEVILLA': { palo: 'Sevillanas', compas: [1,0,1], accents: [1], color: '#e11d48', info: 'Estructura formal (F).' },\n    'C칍RDOBA': { palo: 'Tientos', compas: [1,0,1,0,1,0,1,0], accents: [1,5], color: '#7c2d12', info: 'Consistencia interna (H).' }\n};\n\nlet activeKey = 'JEREZ';\nlet isPlaying = false;\nlet tempo = 120;\nlet currentStep = 0;\n\n// --- INTERFAZ ---\nconst win = document.createElement('div');\nwin.id = winId;\nwin.style.cssText = `position: absolute; top: 20px; left: 150px; width: 480px; z-index: 9999; background: #e0e5ec; border-radius: 35px; box-shadow: 20px 20px 60px #bebebe, -20px -20px 60px #ffffff; font-family: sans-serif; overflow: hidden;`;\n\nconst header = document.createElement('div');\nheader.style.cssText = `padding: 20px; cursor: grab; display: flex; justify-content: space-between;`;\nheader.innerHTML = `<span style=\"font-weight:900; color:#475569;\">游눆 TABLAO V4: EL KI DEL RITMO</span><button id=\"close-${winId}\" style=\"border:none; background:transparent; cursor:pointer;\">칑</button>`;\n\nconst body = document.createElement('div');\nbody.style.cssText = `padding: 0 25px 25px 25px; display: flex; flex-direction: column; gap: 15px;`;\n\n// --- FUNCI칍N DEL CANVAS (OPEN) ---\nconst visualContainer = document.createElement('div');\nvisualContainer.style.cssText = `height: 160px; border-radius: 20px; background: #e0e5ec; box-shadow: inset 8px 8px 16px #b8b9be, inset -8px -8px 16px #ffffff; position: relative;`;\nconst canvas = document.createElement('canvas');\ncanvas.width = 430; canvas.height = 160;\nvisualContainer.appendChild(canvas);\n\nconst c = canvas.getContext('2d');\nlet particles = [];\n\nconst drawCanvas = () => {\n    c.fillStyle = '#e0e5ec';\n    c.fillRect(0, 0, canvas.width, canvas.height);\n    const r = regiones[activeKey];\n    const centerX = canvas.width / 2; const centerY = canvas.height / 2;\n    \n    // Onda de Resonancia (R)\n    const pulse = isPlaying ? (Math.sin(Date.now() * 0.01) * 5) : 0;\n    c.beginPath();\n    c.arc(centerX, centerY, 40 + pulse, 0, Math.PI * 2);\n    c.strokeStyle = r.color + '22';\n    c.lineWidth = 8; c.stroke();\n\n    // Visualizaci칩n del Paso actual (N - N칰mero)\n    r.compas.forEach((step, i) => {\n        const angle = (i / r.compas.length) * Math.PI * 2 - Math.PI/2;\n        const x = centerX + Math.cos(angle) * 60;\n        const y = centerY + Math.sin(angle) * 60;\n        c.beginPath();\n        c.arc(x, y, (currentStep === i && isPlaying) ? 6 : 3, 0, Math.PI * 2);\n        c.fillStyle = (currentStep === i && isPlaying) ? r.color : '#a3b1c6';\n        c.fill();\n    });\n\n    if (isPlaying) {\n        particles.forEach((p, i) => {\n            p.x += p.vx; p.y += p.vy; p.life -= 0.02;\n            c.fillStyle = r.color + Math.floor(p.life * 255).toString(16).padStart(2, '0');\n            c.beginPath(); c.arc(p.x, p.y, 2, 0, Math.PI*2); c.fill();\n            if(p.life <= 0) particles.splice(i, 1);\n        });\n    }\n    requestAnimationFrame(drawCanvas);\n};\n\n// --- L칍GICA DE TIEMPO Y KI (K) ---\nlet lastTick = 0;\nconst updateRhythm = () => {\n    if (!isPlaying) return;\n    const now = audioCtx.currentTime;\n    const stepDuration = (60 / tempo) / 2;\n\n    if (now - lastTick > stepDuration) {\n        const r = regiones[activeKey];\n        currentStep = (currentStep + 1) % r.compas.length;\n        const isAccent = r.accents.includes(currentStep + 1);\n        if (isAccent) {\n            playPercussion('CAJON_BASS', 0.8);\n            for(let i=0; i<8; i++) particles.push({x: 215, y: 80, vx: Math.random()*4-2, vy: Math.random()*4-2, life: 1});\n        } else {\n            playPercussion('PALMA_SECA', 0.2);\n        }\n        lastTick = now;\n    }\n    setTimeout(updateRhythm, 10);\n};\n\n// --- CONTROL DE KI (TEMPO) ---\nconst kiControl = document.createElement('div');\nkiControl.style.cssText = `display: flex; flex-direction: column; gap: 5px;`;\nconst kiLabel = document.createElement('label');\nkiLabel.style.cssText = `font-size: 0.65rem; color: #718096; font-weight: bold;`;\nkiLabel.innerText = `AJUSTE DE KI (CAMINO): ${tempo} BPM`;\nconst kiSlider = document.createElement('input');\nkiSlider.type = 'range'; kiSlider.min = 60; kiSlider.max = 240; kiSlider.value = tempo;\nkiSlider.style.cssText = `accent-color: #7f1d1d; cursor: pointer;`;\nkiSlider.oninput = (e) => {\n    tempo = e.target.value;\n    kiLabel.innerText = `AJUSTE DE KI (CAMINO): ${tempo} BPM`;\n};\nkiControl.append(kiLabel, kiSlider);\n\nconst infoPanel = document.createElement('div');\ninfoPanel.style.cssText = `padding: 10px; border-radius: 15px; background: rgba(0,0,0,0.03); font-size: 0.7rem; color: #475569;`;\n\nconst grid = document.createElement('div');\ngrid.style.cssText = `display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px;`;\n\nObject.keys(regiones).forEach(k => {\n    const b = document.createElement('button');\n    b.innerText = k; b.style.cssText = `padding: 8px 2px; border:none; border-radius:10px; background:#e0e5ec; box-shadow: 3px 3px 6px #b8b9be, -3px -3px 6px #ffffff; cursor:pointer; font-weight:bold; color:#718096; font-size:0.55rem;`;\n    b.onclick = () => { activeKey = k; currentStep = 0; updateText(); };\n    grid.appendChild(b);\n});\n\nconst updateText = () => {\n    const r = regiones[activeKey];\n    infoPanel.innerHTML = `<b style=\"color:${r.color}\">${r.palo}</b>: ${r.info}`;\n};\n\nconst btnPlay = document.createElement('button');\nbtnPlay.innerText = \"SOLTAR DUENDE\";\nbtnPlay.style.cssText = `width:100%; padding: 15px; border:none; border-radius:20px; background:#7f1d1d; color:white; font-weight:900; cursor:pointer; box-shadow: 0 6px 15px rgba(127, 29, 29, 0.3);`;\nbtnPlay.onclick = () => {\n    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();\n    isPlaying = !isPlaying;\n    btnPlay.innerText = isPlaying ? \"DETENER RESONANCIA\" : \"SOLTAR DUENDE\";\n    btnPlay.style.background = isPlaying ? \"#475569\" : \"#7f1d1d\";\n    if(isPlaying) updateRhythm();\n};\n\nbody.append(visualContainer, kiControl, infoPanel, grid, btnPlay);\nwin.append(header, body); document.body.appendChild(win);\n\n// ARRASTRE\nlet dragging = false, offset = {x:0, y:0};\nheader.onmousedown = (e) => { dragging = true; offset.x = e.clientX - win.offsetLeft; offset.y = e.clientY - win.offsetTop; };\nwindow.onmousemove = (e) => { if(dragging) { win.style.left = (e.clientX - offset.x)+'px'; win.style.top = (e.clientY - offset.y)+'px'; } };\nwindow.onmouseup = () => dragging = false;\ndocument.getElementById(`close-${winId}`).onclick = () => { isPlaying = false; win.remove(); };\n\ndrawCanvas(); updateText();\nreturn \"Tablao V4 (KI) Iniciado\";\n"
      }
    ]
  },
  "x": 0,
  "y": 0,
  "icon": "activity",
  "color": "text-rose-900"
}